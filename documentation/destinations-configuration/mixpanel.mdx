# Mixpanel

<Hint>
    <ul>
        <li>Mixpanel destination is available in `beta` version only</li>
        <li>This section of documentation is still in progress</li>
    </ul>
</Hint>

**Jitsu** supports [Mixpanel](https://mixpanel.com) as a destination and
sends data using  [Ingestion API](https://developer.mixpanel.com/reference/ingestion-api).

Jitsu sends events to Ingestion API filling as much Mixpanel [Events Properties](https://help.mixpanel.com/hc/en-us/articles/115004613766#ingestion-api) as possible from original event data.

Mixpanel destination may also send User Profiles data to Mixpanel accounts that have User Profiles enabled.

## Events Customization

Mixpanel destination relies on JavaScript Transform.
Default implementation passes incoming event to `toMixpanel` javascript method that does all transformations:
```javascript
return toMixpanel($, {userProfileUpdates: {}, additionalProperties: {}, overriddenEventName: ''})
```
`toMixpanel` source code may be found in [jitsu github repository](https://github.com/jitsucom/jitsu/blob/master/server/templates/js/transform/mixpanel.js). 

You can extract additional properties from incoming event and pass it to `toMixpanel` – they will be added to Mixpanel event:
```javascript
const myProperties = {
    "Title": $.page_title
}
return toMixpanel($, {userProfileUpdates: {}, additionalProperties: myProperties, overriddenEventName: ''})
```

You can set your own event names based on incoming event data:
```javascript
let myEventName = ''
if ($.doc_path?.startsWith("/shop/")) {
    myEventName = "Shop Page"
}
return toMixpanel($, {userProfileUpdates: {}, additionalProperties: {}, overriddenEventName: myEventName})
```

## Tracking Revenue

In addition to Mixpanel Default properties, Jitsu automatically sets `Revenue` field for each event if original event has `revenue` field, e.g. `conversion`


## User Profiles

If enabled Jitsu sets [Mixpanel User Profiles](https://help.mixpanel.com/hc/en-us/articles/115004708186-Profile-Properties) properties 
from `user_identify` events.

### Aliases

Jitsu automatically create aliases in Mixpanel on  `user_identify` events if `user.internal_id` or `user.email` is present in event along with `user.anonymous_id`.

### User Profiles properties and counters

Jitsu automatically updates following User Profile properties on every event except `user_identify`: 
* `Last ${event name or type}` with `_timestamp` of incoming event. E.g.: `Last Page View: 2021-11-11T16:12:41`  
* `${event name or type}` – increments counter by 1 for each event. E.g.: `Page View: 1`
  
Jitsu automatically increments `Lifetime Revenue` User Profile property on events with `revenue` field like `conversion`

### Revenue transactions

If your Mixpanel pricing plan includes the Revenue report you may customize Javascript to track charges that will appear in the Revenue report:
```javascript
let userProfileUpdates = {
  "$append": {
    "$transactions": {
      "$amount": $.conversion?.revenue || $.revenue
    }
  }
}

return toMixpanel($, {userProfileUpdates: userProfileUpdates, additionalProperties: {}, overriddenEventName: ''})
```

### Other User Profile settings

You can use `userProfileUpdates` object to trigger any method that is supported by [Ingestion API for User Profiles](https://developer.mixpanel.com/reference/profile-append-to-list-property).
Just add corresponding block to  `userProfileUpdates` object that you pass to `toMixpanel` and jitsu will convert it to API call.

E.g., to [Increment Numerical Property](https://developer.mixpanel.com/reference/profile-numerical-add):

```javascript
let userProfileUpdates = {
  "$add": {
    "Coins Gathered": 12
  }
}
return toMixpanel($, {userProfileUpdates: userProfileUpdates, additionalProperties: {}, overriddenEventName: ''})
```

[Union To List Property](https://developer.mixpanel.com/reference/user-profile-union):

```javascript
let userProfileUpdates = {
  "$union": {
    "Items purchased": ["socks", "shirts"]
  }
}
return toMixpanel($, {userProfileUpdates: userProfileUpdates, additionalProperties: {}, overriddenEventName: ''})
```

## Skipping events

If not all event types are needed in Mixpanel – you can skip unnecessary evens using general skip logic by returning `null`:
```javascript
if ($.event_type === "not_interesting") {
  return null
}
return toMixpanel($, {userProfileUpdates: {}, additionalProperties: {}, overriddenEventName: ''})
```


## Configuration

Mixpanel destination config consists of the following schema:

```yaml
destinations:
  my_mixpanel:
    type: webhook
    subtype: mixpanel
    mode: stream
    data_layout:
      transform_enabled: true
      transform: |
        return toMixpanel($, /* User Profile updates */ {},  /*Additional Event properties */ {}, /* Overridden event name*/ '')
    template_variables:
      token: abc123abc123abc123
      users_enabled: true
      anonymous_users_enabled: false
```

### Configuration Parameters

Configuration parameters for Mixpanel destination must be provided under `template_variables` object. See example above.

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
          <b>token</b>
          <br />
          <em>(required)</em>
      </td>
      <td>string</td>
      <td><a href="https://developer.mixpanel.com/reference/project-token">Project Token</a>. A project's token can be found in the Access Keys section of a project's settings overview page: <a href="https://mixpanel.com/settings/project/">https://mixpanel.com/settings/project/</a></td>
    </tr>
    <tr>
      <td>
          <b>users_enabled</b>
      </td>
      <td>boolean</td>
      <td>Enables Mixpanel destination to work with User Profiles. See <a href="#user-profiles">User Profiles</a> section</td>
    </tr>
    <tr>
      <td>
          <b>anonymous_users_enabled</b>
      </td>
      <td>boolean</td>
      <td>Enables updating User Profiles for anonymous users. Requires <b>users_enabled</b> set to <b>true</b></td>
    </tr>
  </tbody>
</table>

